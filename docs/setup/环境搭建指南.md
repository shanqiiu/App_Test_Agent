# 环境搭建指南

本指南将帮助你从零开始搭建 App_Test_Agent 的本地开发环境。

---

## 1. 系统要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 4核 | 8核及以上 |
| 内存 | 8GB | 16GB及以上 |
| 显卡 | 无（CPU模式） | NVIDIA GPU 8GB+ VRAM |
| 硬盘 | 50GB 可用空间 | 100GB SSD |

### 软件要求

- **操作系统**: Windows 10/11, macOS 12+, 或 Ubuntu 20.04+
- **Python**: 3.9 - 3.11（推荐 3.10）
- **Git**: 2.0+
- **Node.js** (可选，用于 Playwright): 16.0+

---

## 2. 克隆项目

```bash
git clone https://github.com/your-org/App_Test_Agent.git
cd App_Test_Agent
```

---

## 3. Python 环境配置

### 3.1 创建虚拟环境

#### 使用 venv (推荐)

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS/Linux
python3 -m venv venv
source venv/bin/activate
```

#### 使用 conda

```bash
conda create -n app-test-agent python=3.10
conda activate app-test-agent
```

### 3.2 安装依赖

#### img2text2html2img 项目

```bash
cd prototypes/img2text2html2img/scripts
pip install -r requirements.txt
```

**核心依赖**:
- `pillow` - 图像处理
- `requests` - HTTP 请求
- `playwright` - HTML 渲染
- `omniparser-v2` (可选) - UI 组件检测

**安装 Playwright 浏览器**:
```bash
playwright install chromium
```

#### ui_semantic_patch 项目

```bash
cd ../../../prototypes/ui_semantic_patch/scripts
pip install -r requirements.txt
```

**核心依赖**:
- `pillow` - 图像处理
- `requests` - HTTP 请求
- `dashscope` - AI 图像生成
- `paddleocr` (可选) - 本地 OCR
- PyTorch (用于 OmniParser)

---

## 4. API 密钥配置

### 4.1 复制配置模板

```bash
cp .env.example .env
```

### 4.2 编辑配置文件

打开 `.env` 文件并填入实际的 API 密钥：

```bash
# 必需：VLM API (OpenAI 兼容接口)
API_KEY=sk-xxxxxxxxxxxxxxxxxxxx
API_URL=https://api.openai-next.com/v1/chat/completions

# 可选：DashScope API (AI 图像生成)
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxx
```

### 4.3 获取 API 密钥

| 服务 | 获取地址 | 用途 |
|------|---------|------|
| OpenAI 兼容 API | [api.openai-next.com](https://api.openai-next.com) | UI 分析和 HTML 生成 |
| DashScope | [阿里云DashScope](https://dashscope.aliyun.com/) | AI 弹窗图像生成（可选） |

---

## 5. OmniParser 模型配置

### 5.1 选项1：使用本地集成 (推荐)

`ui_semantic_patch` 项目已内置 OmniParser:

```bash
cd prototypes/ui_semantic_patch/third_party/OmniParser
```

**模型权重**: 已包含在 `weights/` 目录下

### 5.2 选项2：使用 pip 包

```bash
pip install omniparser-v2
```

### 5.3 GPU 配置（可选但推荐）

#### 安装 PyTorch with CUDA

```bash
# CUDA 11.8
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

#### 验证 CUDA 可用性

```python
python -c "import torch; print(torch.cuda.is_available())"
# 输出 True 表示成功
```

---

## 6. 验证安装

### 6.1 测试 img2text2html2img

```bash
cd prototypes/img2text2html2img/scripts

# 快速模式测试
python pipeline.py -i data/test.jpg --mode fast
```

**预期输出**:
```
# UI复刻流水线
# 模式: 快速模式 (仅 VL)
...
# 完成: 成功 1, 失败 0
```

### 6.2 测试 ui_semantic_patch

```bash
cd ../../ui_semantic_patch/scripts

# 基础测试
python run_pipeline.py \
  --screenshot ../examples/广告弹窗.jpg \
  --instruction "模拟网络超时弹窗" \
  --render-mode semantic_pil
```

**预期输出**:
```
[Stage 1] OmniParser 粗检测
[Stage 2] VLM 语义过滤
[Stage 3] VLM 生成 JSON Patch
[Stage 4] 渲染异常场景
✓ 异常截图已保存: ...
```

---

## 7. 常见问题

### Q1: `ModuleNotFoundError: No module named 'xxx'`

**解决**:
```bash
pip install xxx
```

### Q2: OmniParser 模型加载失败

**解决**:
```bash
# 检查模型文件是否存在
ls prototypes/ui_semantic_patch/third_party/OmniParser/weights/

# 如果缺失，重新克隆项目
git submodule update --init --recursive
```

### Q3: `torch.cuda.is_available()` 返回 False

**解决**:
1. 确认安装了 NVIDIA 驱动
2. 检查 CUDA 版本匹配
3. 重新安装对应版本的 PyTorch

### Q4: Playwright 浏览器未安装

**解决**:
```bash
playwright install chromium
```

### Q5: API Key 未生效

**解决**:
1. 确认 `.env` 文件在项目根目录
2. 检查是否正确填写 `API_KEY=` 后的值
3. 尝试使用命令行参数覆盖: `--api-key YOUR_KEY`

---

## 8. 下一步

环境配置完成后，你可以：

1. **阅读项目文档**: [docs/](../../docs/)
2. **查看示例**: [prototypes/*/examples/](../../prototypes/)
3. **运行测试用例**: 参考各项目的 README.md
4. **开始开发**: 参考 [CLAUDE.md](../../Claude.md)

---

## 9. 更新日志

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-02-03 | v1.0 | 初始版本 |

---

**遇到问题？** 请提交 Issue: [GitHub Issues](https://github.com/your-org/App_Test_Agent/issues)
