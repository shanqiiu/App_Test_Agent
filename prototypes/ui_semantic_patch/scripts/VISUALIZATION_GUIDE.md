# OmniParser æ£€æµ‹ç»“æœå¯è§†åŒ–æŒ‡å—

## æ¦‚è¿°

OmniParser çš„ Stage 1 è¾“å‡ºåŒ…å«æ£€æµ‹åˆ°çš„æ‰€æœ‰ UI ç»„ä»¶çš„ä½ç½®ã€ç±»å‹å’Œå±æ€§ã€‚æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•å¯è§†åŒ–è¿™äº›æ£€æµ‹ç»“æœä»¥éªŒè¯å’Œè°ƒè¯•ã€‚

## å¯è§†åŒ–å·¥å…·

### 1. `visualize_omni.py` - é€šç”¨å¯è§†åŒ–å·¥å…·

å°† UI-JSON æ ¼å¼çš„ç»„ä»¶åˆ—è¡¨å¯è§†åŒ–åˆ°æˆªå›¾ä¸Šã€‚

#### ä½¿ç”¨æ–¹æ³•

```bash
# åŸºæœ¬ç”¨æ³•
python visualize_omni.py \
  --screenshot ./screenshot.png \
  --ui-json ./screenshot_structure.json \
  --output ./annotated.png

# è‡ªå®šä¹‰å­—ä½“å’Œè¾¹æ¡†å¤§å°
python visualize_omni.py \
  --screenshot ./screenshot.png \
  --ui-json ./screenshot_structure.json \
  --output ./annotated.png \
  --font-size 12 \
  --border-width 3

# ä¸æ˜¾ç¤ºæ–‡æœ¬æ ‡ç­¾ï¼ˆä»…æ˜¾ç¤ºè¾¹ç•Œæ¡†ï¼‰
python visualize_omni.py \
  --screenshot ./screenshot.png \
  --ui-json ./screenshot_structure.json \
  --output ./annotated.png \
  --no-text
```

#### å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|-------|
| `--screenshot` / `-s` | åŸå§‹æˆªå›¾è·¯å¾„ | å¿…éœ€ |
| `--ui-json` / `-j` | UI-JSON æ–‡ä»¶è·¯å¾„ | å¿…éœ€ |
| `--output` / `-o` | è¾“å‡ºå›¾ç‰‡è·¯å¾„ | è‡ªåŠ¨ç”Ÿæˆ |
| `--font-size` | æ ‡ç­¾å­—ä½“å¤§å°ï¼ˆåƒç´ ï¼‰| 10 |
| `--border-width` | è¾¹ç•Œæ¡†çº¿å®½ï¼ˆåƒç´ ï¼‰| 2 |
| `--no-text` | ä¸æ˜¾ç¤ºæ–‡æœ¬æ ‡ç­¾ | False |
| `--no-save` | ä¸ä¿å­˜æ–‡ä»¶ | False |

### 2. `visualize_pipeline_stage1.py` - å¿«é€Ÿå¯è§†åŒ–å·¥å…·

ä¸“é—¨ä¸º `run_pipeline.py` çš„ Stage 1 è¾“å‡ºè®¾è®¡çš„ä¾¿æ·å·¥å…·ã€‚

#### ä½¿ç”¨æµç¨‹

```bash
# æ­¥éª¤ 1: è¿è¡Œ pipeline
python run_pipeline.py \
  --screenshot ./test.png \
  --instruction "ç½‘ç»œè¶…æ—¶å¼¹çª—" \
  --output ./output/

# æ­¥éª¤ 2: å¯è§†åŒ– Stage 1 æ£€æµ‹ç»“æœ
python visualize_pipeline_stage1.py \
  --screenshot ./test.png \
  --stage1-json ./output/test_stage1_omni_raw_20260131_150632.json \
  --output ./test_stage1_annotated.png
```

#### å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|-------|
| `--screenshot` / `-s` | åŸå§‹æˆªå›¾è·¯å¾„ | å¿…éœ€ |
| `--stage1-json` / `-j` | Stage 1 JSON æ–‡ä»¶ | å¿…éœ€ |
| `--output` / `-o` | è¾“å‡ºå›¾ç‰‡è·¯å¾„ | è‡ªåŠ¨ç”Ÿæˆ |
| `--font-size` | æ ‡ç­¾å­—ä½“å¤§å° | 10 |
| `--border-width` | è¾¹ç•Œæ¡†çº¿å®½ | 2 |

## å¯è§†åŒ–è¯´æ˜

### é¢œè‰²æ˜ å°„

ä¸åŒçš„ UI ç»„ä»¶ç±»å‹ç”¨ä¸åŒé¢œè‰²è¡¨ç¤ºï¼š

| ç»„ä»¶ç±»å‹ | é¢œè‰² | è¯´æ˜ |
|---------|------|------|
| Button | ğŸ”´ çº¢è‰² (#FF6B6B) | å¯ç‚¹å‡»çš„æŒ‰é’® |
| TextView | ğŸ”µ é’è‰² (#4ECDC4) | çº¯æ–‡æœ¬è§†å›¾ |
| ImageButton | ğŸŸ¡ é»„è‰² (#FFE66D) | å›¾æ ‡æŒ‰é’® |
| ImageView | ğŸŸ¢ æµ…ç»¿ (#95E1D3) | å›¾ç‰‡è§†å›¾ |
| SearchBar | ğŸŒ¸ ç²‰è‰² (#F38181) | æœç´¢æ  |
| Dialog | ğŸ”® æ·±ç²‰ (#FF6B9D) | å¯¹è¯æ¡† |
| Toast | ğŸŸ¤ æ£•çº¢ (#C44569) | åå¸æç¤º |
| Card | ğŸ’™ æµ…è“ (#A8D8EA) | å¡ç‰‡ |
| Avatar | ğŸ’œ ç´«è‰² (#AA96DA) | å¤´åƒ |
| Checkbox | ğŸ’— æµ…ç²‰ (#FCBAD3) | å¤é€‰æ¡† |
| Switch | ğŸ’ æµ…è“ (#A2D5F7) | å¼€å…³ |
| TabBar | ğŸŸ  æ©™è‰² (#FFD3B6) | æ ‡ç­¾æ  |
| NavigationBar | ğŸŸ¦ æ·±ç»¿ (#2A9D8F) | å¯¼èˆªæ  |
| StatusBar | ğŸŸ© æ·±è“ (#264653) | çŠ¶æ€æ  |

### æ ‡ç­¾ä¿¡æ¯

æ¯ä¸ªç»„ä»¶ä¸Šæ–¹æ˜¾ç¤ºï¼š
- `[ç´¢å¼•]` - ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®
- `ç±»å‹` - ç»„ä»¶çš„ UI ç±»å‹
- `æ–‡æœ¬` - ç»„ä»¶çš„æ–‡æœ¬å†…å®¹ï¼ˆå¦‚æœ‰ï¼‰

ç¤ºä¾‹ï¼š`[5] Button\nç¡®è®¤`

### å‡ ä½•æ ‡è®°

- **çŸ©å½¢è¾¹æ¡†** - ç»„ä»¶çš„è¾¹ç•Œï¼ˆx, y, width, heightï¼‰
- **åœ†ç‚¹** - ç»„ä»¶çš„ä¸­å¿ƒç‚¹

## å·¥ä½œæµç¤ºä¾‹

### åœºæ™¯ 1: è°ƒè¯• OmniParser æ£€æµ‹

```bash
# 1. ç›´æ¥ä½¿ç”¨ omni_extractor.py æ£€æµ‹å•å¼ å›¾ç‰‡
python omni_extractor.py \
  --image ./test.png \
  --output ./test_structure.json

# 2. å¯è§†åŒ–æ£€æµ‹ç»“æœ
python visualize_omni.py \
  --screenshot ./test.png \
  --ui-json ./test_structure.json \
  --output ./test_annotated.png

# 3. æŸ¥çœ‹è¾“å‡º
# æ‰“å¼€ test_annotated.pngï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ï¼š
#   - é—æ¼çš„ç»„ä»¶ï¼ˆå‡é˜³æ€§ï¼‰
#   - é”™è¯¯çš„ç»„ä»¶ç±»å‹åˆ†ç±»
#   - è¾¹ç•Œæ¡†æ˜¯å¦å‡†ç¡®
```

### åœºæ™¯ 2: è°ƒè¯•å®Œæ•´ Pipeline

```bash
# 1. è¿è¡Œ pipeline
python run_pipeline.py \
  --screenshot ./test.png \
  --instruction "ç½‘ç»œè¶…æ—¶é”™è¯¯" \
  --output ./pipeline_output/

# 2. å¯è§†åŒ– Stage 1ï¼ˆOmniParser åŸå§‹æ£€æµ‹ï¼‰
python visualize_pipeline_stage1.py \
  --screenshot ./test.png \
  --stage1-json ./pipeline_output/test_stage1_omni_raw_*.json

# 3. å¯è§†åŒ– Stage 2ï¼ˆVLM è¯­ä¹‰è¿‡æ»¤åï¼‰
python visualize_omni.py \
  --screenshot ./test.png \
  --ui-json ./pipeline_output/test_stage2_filtered_*.json \
  --output ./pipeline_output/test_stage2_annotated.png

# 4. æ¯”è¾ƒä¸¤ä¸ªå¯è§†åŒ–ç»“æœ
#   - Stage 1: çœ‹åŸå§‹ OmniParser çš„æ£€æµ‹ç»“æœ
#   - Stage 2: çœ‹ VLM è¿‡æ»¤å’Œåˆå¹¶åçš„ç»“æœ
#   - æ£€æŸ¥ VLM æ˜¯å¦æ­£ç¡®å¤„ç†äº†å†—ä½™å’Œé”™è¯¯çš„æ£€æµ‹æ¡†
```

### åœºæ™¯ 3: éªŒè¯ç»„ä»¶è¾¹ç•Œæ¡†å‡†ç¡®æ€§

```bash
# 1. ç”Ÿæˆå¯è§†åŒ–
python visualize_omni.py \
  --screenshot ./test.png \
  --ui-json ./test_structure.json \
  --output ./annotated.png \
  --font-size 12 \
  --border-width 3

# 2. é€ä¸ªæ£€æŸ¥ç»„ä»¶ï¼š
#   - è¾¹ç•Œæ¡†æ˜¯å¦åŒ…å«äº†å®Œæ•´çš„ UI å…ƒç´ ï¼Ÿ
#   - æ˜¯å¦æœ‰å¤šä½™çš„ç©ºç™½åŒºåŸŸï¼Ÿ
#   - æ–‡æœ¬æ ‡ç­¾æ˜¯å¦æ­£ç¡®è¯†åˆ«äº†ç»„ä»¶å†…å®¹ï¼Ÿ
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæœ‰äº›ç»„ä»¶çš„è¾¹ç•Œæ¡†ä¸å‡†ç¡®ï¼Ÿ

**A:** è¿™é€šå¸¸æ˜¯å› ä¸ºï¼š
1. **OmniParser çš„ YOLO æ¨¡å‹é™åˆ¶** - æ— æ³•å®Œç¾æ•æ‰æ‰€æœ‰è¾¹ç•Œ
2. **å›¾ç‰‡è´¨é‡é—®é¢˜** - ä½åˆ†è¾¨ç‡æˆ–æ¨¡ç³Šçš„æˆªå›¾ä¼šé™ä½æ£€æµ‹ç²¾åº¦
3. **UI è®¾è®¡ç‰¹æ®Šæ€§** - æŸäº›å¤æ‚çš„ UI ç»“æ„ï¼ˆå¦‚é‡å å…ƒç´ ï¼‰éš¾ä»¥å‡†ç¡®æ£€æµ‹

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `run_pipeline.py` çš„ Stage 2 è¾“å‡ºï¼Œçœ‹ VLM æ˜¯å¦æ­£ç¡®è¿‡æ»¤äº†ä¸å‡†ç¡®çš„æ£€æµ‹æ¡†
- å¦‚æœ Stage 2 ä»æœ‰é—®é¢˜ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ OmniParser çš„æ£€æµ‹é˜ˆå€¼

### Q: ä¸ºä»€ä¹ˆæŸä¸ªç»„ä»¶è¢«åˆ†ç±»ä¸ºé”™è¯¯çš„ç±»å‹ï¼Ÿ

**A:** è¿™æ˜¯ `omni_extractor.py` ä¸­çš„ `map_element_type()` å‡½æ•°çš„åˆ†ç±»é€»è¾‘ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `omni_extractor.py:140-188` çš„åˆ†ç±»è§„åˆ™
- å¦‚æœåˆ†ç±»ä¸å‡†ç¡®ï¼Œå¯ä»¥ä¿®æ”¹å…³é”®å­—åŒ¹é…æˆ–æ·»åŠ æ›´å¤šè§„åˆ™
- VLM è¯­ä¹‰è¿‡æ»¤ï¼ˆStage 2ï¼‰å¯èƒ½ä¼šè‡ªåŠ¨çº æ­£è¿™äº›åˆ†ç±»

### Q: ç”Ÿæˆçš„å¯è§†åŒ–å›¾å¤ªæš—æˆ–å¤ªäº®ï¼Ÿ

**A:** è¿™æ˜¯å­—ä½“é¢œè‰²æˆ–èƒŒæ™¯å¯¹æ¯”åº¦çš„é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- å°è¯•è°ƒæ•´ `--font-size` å’Œ `--border-width` å‚æ•°
- ä¿®æ”¹ `visualize_omni.py:219-225` ä¸­çš„æ–‡æœ¬é¢œè‰²æˆ–èƒŒæ™¯é¢œè‰²

## æŠ€æœ¯ç»†èŠ‚

### åæ ‡ç³»

- **åŸç‚¹ (0, 0)** - å›¾ç‰‡çš„å·¦ä¸Šè§’
- **X è½´** - ä»å·¦åˆ°å³
- **Y è½´** - ä»ä¸Šåˆ°ä¸‹
- **åæ ‡å€¼** - åƒç´ å€¼ï¼ˆæ•´æ•°ï¼‰

### è¾“å‡ºæ ¼å¼

å¯è§†åŒ–è„šæœ¬è¾“å‡ºæ ‡å‡†çš„ PNG å›¾ç‰‡ï¼Œå¯ä»¥ç”¨ä»»ä½•å›¾ç‰‡æŸ¥çœ‹å™¨æ‰“å¼€ã€‚

### æ€§èƒ½

- å°å›¾ç‰‡ï¼ˆ<1000x1000ï¼‰: å³æ—¶ç”Ÿæˆ
- ä¸­ç­‰å›¾ç‰‡ï¼ˆ1000x3000ï¼‰: 1-2 ç§’
- å¤§å›¾ç‰‡ï¼ˆ>3000x3000ï¼‰: 2-5 ç§’

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|-----|------|
| `visualize_omni.py` | é€šç”¨å¯è§†åŒ–å·¥å…· |
| `visualize_pipeline_stage1.py` | Pipeline å¿«é€Ÿå¯è§†åŒ– |
| `omni_extractor.py` | OmniParser æ£€æµ‹å·¥å…· |
| `omni_vlm_fusion.py` | OmniParser + VLM èåˆ |
| `run_pipeline.py` | å®Œæ•´çš„ 3 é˜¶æ®µ Pipeline |

## åç»­æ­¥éª¤

å¯è§†åŒ–åï¼Œå¯ä»¥ï¼š

1. **éªŒè¯ Stage 1 æ£€æµ‹** - æ˜¯å¦é—æ¼æˆ–è¿‡åº¦æ£€æµ‹ï¼Ÿ
2. **æ£€æŸ¥ Stage 2 è¿‡æ»¤** - VLM æ˜¯å¦æ­£ç¡®å¤„ç†äº†å†—ä½™ï¼Ÿ
3. **è°ƒæ•´å‚æ•°** - æ ¹æ®å¯è§†åŒ–ç»“æœè°ƒæ•´é˜ˆå€¼
4. **ç”Ÿæˆå¼‚å¸¸åœºæ™¯** - åœ¨éªŒè¯é€šè¿‡åè¿è¡Œå®Œæ•´ Pipeline

## è„šæœ¬æºç 

- `visualize_omni.py` (265 è¡Œ) - æ ¸å¿ƒå¯è§†åŒ–é€»è¾‘
- `visualize_pipeline_stage1.py` (80 è¡Œ) - Pipeline é›†æˆ

